name: Release

on:
  push:
    tags: ['v*']

env:
  PACKAGE_NAME: boosty-downloader

jobs:
  validate:
    name: üîç Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v6

      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "üì¶ Release version: $VERSION"

      - name: Validate CHANGELOG
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [ ! -f CHANGELOG.md ]; then
            echo "‚ùå CHANGELOG.md not found"
            exit 1
          fi
          if ! grep -q "$VERSION" CHANGELOG.md; then
            echo "‚ùå Version $VERSION not found in CHANGELOG.md"
            exit 1
          fi
          echo "‚úÖ CHANGELOG.md contains version $VERSION"

      - name: Check PyPI availability
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PYPI_VERSION=$(curl -s "https://pypi.org/pypi/$PACKAGE_NAME/json" \
            | jq -r '.releases | keys_unsorted | last // "0.0.0"' 2>/dev/null || echo "0.0.0")
          echo "üì¶ PyPI version: $PYPI_VERSION"

          if [ "$VERSION" = "$PYPI_VERSION" ]; then
            echo "‚ùå Version $VERSION already exists on PyPI"
            exit 1
          fi
          echo "‚úÖ Version $VERSION is available for release"

  build:
    name: üî® Build
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python & Poetry
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: snok/install-poetry@v1

      - name: Install dependencies & build
        run: |
          make deps
          make build
        timeout-minutes: 10

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  release:
    name: üöÄ Release
    needs: [validate, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    environment:
      name: release
    steps:
      - uses: actions/checkout@v6

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Verify tag
        run: |
          VERSION=${{ needs.validate.outputs.version }}
          echo "üì¶ Releasing version: $VERSION"

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=${{ needs.validate.outputs.version }}
          gh release create "v$VERSION" dist/* --title "v$VERSION" --generate-notes
